{% extends "base.html" %}

{% block head %}
<style>
    .upload-area {
        border: 3px dashed #007bff;
        border-radius: 10px;
        padding: 40px;
        text-align: center;
        background-color: #f8f9fa;
        transition: all 0.3s ease;
    }
    
    .upload-area:hover {
        border-color: #0056b3;
        background-color: #e3f2fd;
    }
    
    .upload-area.dragover {
        border-color: #28a745;
        background-color: #d4edda;
    }
    
    .preview-container {
        max-width: 400px;
        margin: 20px auto;
    }
    
    .preview-image {
        max-width: 100%;
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .result-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px;
        padding: 25px;
        margin-top: 20px;
    }
    
    /* ì¹´ë©”ë¼ ë²„íŠ¼ ê°•ì œ í‘œì‹œ */
    #cameraBtn {
        display: inline-block !important;
        visibility: visible !important;
        opacity: 1 !important;
        position: relative !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row">
        <div class="col-lg-8 mx-auto">
            <!-- í—¤ë” -->
            <div class="text-center mb-5">
                <h1 class="display-4 fw-bold text-primary">
                    ğŸ¢ ê±´ì¶• ì™¸ì¥ì¬ ë¶„ë¥˜ê¸°
                </h1>
                <p class="lead text-muted">
                    AI ê¸°ìˆ ë¡œ ê±´ì¶• ì™¸ì¥ ë§ˆê°ì¬ë¥¼ ìë™ìœ¼ë¡œ ë¶„ë¥˜í•©ë‹ˆë‹¤
                </p>
            </div>

            <!-- ì—…ë¡œë“œ ì˜ì—­ -->
            <div class="card shadow-lg border-0">
                <div class="card-body p-4">
                    <div class="upload-area" id="uploadArea">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">ğŸ“¤</div>
                        <h4>ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”</h4>
                        <p class="text-muted mb-3">
                            íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ ì•„ë˜ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”
                        </p>
                        <input type="file" id="imageInput" accept="image/*" style="display: none;">
                        <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; margin: 0 auto;">
                            <button type="button" class="btn btn-primary btn-lg" id="fileSelectBtn">
                                ğŸ“ íŒŒì¼ ì„ íƒ
                            </button>
                            <button type="button" class="btn btn-success btn-lg" id="cameraBtn">
                                ğŸ“· ì¹´ë©”ë¼ ì´¬ì˜
                            </button>
                        </div>
                        <div class="mt-3">
                            <small class="text-muted">
                                ì§€ì› í˜•ì‹: JPG, PNG, WEBP | ìµœëŒ€ í¬ê¸°: 10MB
                            </small>
                        </div>
                    </div>

                    <!-- ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° -->
                    <div id="previewContainer" class="preview-container" style="display: none;">
                        <img id="previewImage" class="preview-image" alt="ë¯¸ë¦¬ë³´ê¸°">
                        <div class="text-center mt-3">
                            <button type="button" class="btn btn-success btn-lg" id="analyzeBtn">
                                ğŸ” ë¶„ì„ ì‹œì‘
                            </button>
                            <button type="button" class="btn btn-outline-secondary ms-2" id="cancelBtn">
                                âŒ ì·¨ì†Œ
                            </button>
                        </div>
                    </div>

                    <!-- ë¡œë”© -->
                    <div id="loadingContainer" class="text-center py-4" style="display: none;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">ë¶„ì„ ì¤‘...</span>
                        </div>
                        <div class="mt-3">
                            <h5>AIê°€ ì´ë¯¸ì§€ë¥¼ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...</h5>
                            <p class="text-muted">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”</p>
                        </div>
                    </div>

                    <!-- ê²°ê³¼ í‘œì‹œ -->
                    <div id="resultContainer" style="display: none;">
                        <div class="result-card">
                            <div class="text-center">
                                <h3 id="materialName"></h3>
                                <div class="mt-3">
                                    <h6>ì‹ ë¢°ë„: <span id="confidenceText"></span></h6>
                                    <h6>ì²˜ë¦¬ ì‹œê°„: <span id="processingTime"></span></h6>
                                </div>
                            </div>
                        </div>

                        <div class="card mt-4">
                            <div class="card-body">
                                <h5 class="card-title">ì™¸ì¥ì¬ ì •ë³´</h5>
                                <p id="materialDescription" class="card-text"></p>
                            </div>
                        </div>

                        <div class="text-center mt-4">
                            <button type="button" class="btn btn-primary btn-lg" id="resetBtn">
                                â• ë‹¤ë¥¸ ì´ë¯¸ì§€ ë¶„ì„
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ì¹´ë©”ë¼ ëª¨ë‹¬ -->
<div class="modal fade" id="cameraModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ğŸ“· ì¹´ë©”ë¼ë¡œ ì´¬ì˜í•˜ê¸°</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="text-center">
                    <div id="cameraContainer" class="mb-3">
                        <video id="cameraVideo" width="100%" height="300" autoplay muted style="border-radius: 10px; background: #000;"></video>
                    </div>
                    
                    <div id="capturedContainer" class="mb-3" style="display: none;">
                        <canvas id="capturedCanvas" style="border-radius: 10px; max-width: 100%;"></canvas>
                    </div>
                    
                    <div id="cameraStatus" class="alert alert-info">
                        ì¹´ë©”ë¼ ì ‘ê·¼ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”
                    </div>
                    
                    <div id="cameraControls" class="mt-3" style="display: none;">
                        <button type="button" class="btn btn-primary btn-lg" id="captureBtn">
                            ğŸ“¸ ì‚¬ì§„ ì´¬ì˜
                        </button>
                    </div>
                    
                    <div id="captureControls" class="mt-3" style="display: none;">
                        <button type="button" class="btn btn-success btn-lg me-2" id="analyzeCapBtn">
                            ğŸ” ë¶„ì„í•˜ê¸°
                        </button>
                        <button type="button" class="btn btn-outline-secondary me-2" id="retakeBtn">
                            ğŸ”„ ë‹¤ì‹œ ì´¬ì˜
                        </button>
                        <button type="button" class="btn btn-outline-danger" id="closeCamBtn">
                            âŒ ì·¨ì†Œ
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let selectedFile = null;
let cameraStream = null;
let capturedImageData = null;

// DOM ìš”ì†Œ
const uploadArea = document.getElementById('uploadArea');
const imageInput = document.getElementById('imageInput');
const fileSelectBtn = document.getElementById('fileSelectBtn');
const cameraBtn = document.getElementById('cameraBtn');
const previewContainer = document.getElementById('previewContainer');
const previewImage = document.getElementById('previewImage');
const analyzeBtn = document.getElementById('analyzeBtn');
const cancelBtn = document.getElementById('cancelBtn');
const loadingContainer = document.getElementById('loadingContainer');
const resultContainer = document.getElementById('resultContainer');
const resetBtn = document.getElementById('resetBtn');

// ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', function() {
    console.log('í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ');
    
    // íŒŒì¼ ì„ íƒ ë²„íŠ¼
    fileSelectBtn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        console.log('íŒŒì¼ ì„ íƒ ë²„íŠ¼ í´ë¦­');
        imageInput.value = '';
        imageInput.click();
    });
    
    // íŒŒì¼ ì…ë ¥ ë³€ê²½
    imageInput.addEventListener('change', function(e) {
        console.log('íŒŒì¼ ì„ íƒë¨:', e.target.files);
        const file = e.target.files[0];
        if (file) {
            processFile(file);
        }
    });
    
    // ì¹´ë©”ë¼ ë²„íŠ¼
    cameraBtn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        console.log('ì¹´ë©”ë¼ ë²„íŠ¼ í´ë¦­');
        openCamera();
    });
    
    // ë“œë˜ê·¸ ì•¤ ë“œë¡­
    uploadArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    });
    
    uploadArea.addEventListener('dragleave', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
    });
    
    uploadArea.addEventListener('drop', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            processFile(files[0]);
        }
    });
    
    // ë¶„ì„ ë²„íŠ¼
    analyzeBtn.addEventListener('click', analyzeImage);
    
    // ì·¨ì†Œ ë²„íŠ¼
    cancelBtn.addEventListener('click', resetUpload);
    
    // ë¦¬ì…‹ ë²„íŠ¼
    resetBtn.addEventListener('click', resetUpload);
    
    // ì¹´ë©”ë¼ ëª¨ë‹¬ ë²„íŠ¼ë“¤
    document.getElementById('captureBtn').addEventListener('click', capturePhoto);
    document.getElementById('analyzeCapBtn').addEventListener('click', analyzeCapturedImage);
    document.getElementById('retakeBtn').addEventListener('click', retakePhoto);
    document.getElementById('closeCamBtn').addEventListener('click', closeCamera);
});

function processFile(file) {
    console.log('íŒŒì¼ ì²˜ë¦¬ ì‹œì‘:', file.name);
    
    if (!file.type.startsWith('image/')) {
        alert('ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
        return;
    }
    
    if (file.size > 10 * 1024 * 1024) {
        alert('íŒŒì¼ í¬ê¸°ëŠ” 10MB ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤.');
        return;
    }
    
    selectedFile = file;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        previewImage.src = e.target.result;
        showPreview();
    };
    reader.readAsDataURL(file);
}

function showPreview() {
    uploadArea.style.display = 'none';
    previewContainer.style.display = 'block';
    resultContainer.style.display = 'none';
}

function analyzeImage() {
    if (!selectedFile) {
        alert('ë¨¼ì € ì´ë¯¸ì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
    }
    
    console.log('ë¶„ì„ ì‹œì‘');
    previewContainer.style.display = 'none';
    loadingContainer.style.display = 'block';
    resultContainer.style.display = 'none';
    
    const formData = new FormData();
    formData.append('file', selectedFile);
    
    fetch('/api/predict', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        console.log('ë¶„ì„ ê²°ê³¼:', data);
        loadingContainer.style.display = 'none';
        
        if (data.success) {
            displayResult(data);
        } else {
            alert('ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + (data.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
            showPreview();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        loadingContainer.style.display = 'none';
        alert('ì„œë²„ ì—°ê²° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        showPreview();
    });
}

function displayResult(data) {
    const prediction = data.prediction;
    const description = data.description;
    
    document.getElementById('materialName').textContent = description.name || prediction.class;
    document.getElementById('confidenceText').textContent = Math.round(prediction.confidence * 100) + '%';
    document.getElementById('processingTime').textContent = data.processing_time + 'ì´ˆ';
    document.getElementById('materialDescription').textContent = description.description || 'ì„¤ëª…ì´ ì—†ìŠµë‹ˆë‹¤.';
    
    resultContainer.style.display = 'block';
}

function resetUpload() {
    selectedFile = null;
    imageInput.value = '';
    
    uploadArea.style.display = 'block';
    previewContainer.style.display = 'none';
    loadingContainer.style.display = 'none';
    resultContainer.style.display = 'none';
}

// ì¹´ë©”ë¼ í•¨ìˆ˜ë“¤
function openCamera() {
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        alert('ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” ì¹´ë©”ë¼ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        return;
    }
    
    const modal = new bootstrap.Modal(document.getElementById('cameraModal'));
    modal.show();
    
    document.getElementById('cameraModal').addEventListener('shown.bs.modal', function() {
        startCamera();
    }, { once: true });
}

async function startCamera() {
    const video = document.getElementById('cameraVideo');
    const status = document.getElementById('cameraStatus');
    const controls = document.getElementById('cameraControls');
    
    try {
        status.textContent = 'ì¹´ë©”ë¼ë¥¼ ì‹œì‘í•˜ëŠ” ì¤‘...';
        
        cameraStream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: 'user', width: { ideal: 1280 }, height: { ideal: 720 } }
        });
        
        video.srcObject = cameraStream;
        status.textContent = 'ì¹´ë©”ë¼ê°€ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤';
        status.className = 'alert alert-success';
        controls.style.display = 'block';
        
    } catch (error) {
        console.error('ì¹´ë©”ë¼ ì˜¤ë¥˜:', error);
        status.textContent = 'ì¹´ë©”ë¼ì— ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”.';
        status.className = 'alert alert-danger';
    }
}

function capturePhoto() {
    const video = document.getElementById('cameraVideo');
    const canvas = document.getElementById('capturedCanvas');
    const ctx = canvas.getContext('2d');
    
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0);
    
    capturedImageData = canvas.toDataURL('image/jpeg', 0.8);
    
    document.getElementById('cameraContainer').style.display = 'none';
    document.getElementById('capturedContainer').style.display = 'block';
    document.getElementById('cameraControls').style.display = 'none';
    document.getElementById('captureControls').style.display = 'block';
    document.getElementById('cameraStatus').textContent = 'ì‚¬ì§„ì´ ì´¬ì˜ë˜ì—ˆìŠµë‹ˆë‹¤';
}

function retakePhoto() {
    document.getElementById('cameraContainer').style.display = 'block';
    document.getElementById('capturedContainer').style.display = 'none';
    document.getElementById('cameraControls').style.display = 'block';
    document.getElementById('captureControls').style.display = 'none';
    capturedImageData = null;
}

function closeCamera() {
    if (cameraStream) {
        cameraStream.getTracks().forEach(track => track.stop());
        cameraStream = null;
    }
    
    const modal = bootstrap.Modal.getInstance(document.getElementById('cameraModal'));
    modal.hide();
    
    document.getElementById('cameraContainer').style.display = 'block';
    document.getElementById('capturedContainer').style.display = 'none';
    document.getElementById('cameraControls').style.display = 'none';
    document.getElementById('captureControls').style.display = 'none';
    capturedImageData = null;
}

async function analyzeCapturedImage() {
    if (!capturedImageData) {
        alert('ì´¬ì˜ëœ ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    
    // ë°ì´í„°ë¥¼ ë¨¼ì € ë¡œì»¬ ë³€ìˆ˜ì— ì €ì¥ (closeCamera() í˜¸ì¶œ ì‹œ ì „ì—­ ë³€ìˆ˜ê°€ ì´ˆê¸°í™”ë˜ë¯€ë¡œ)
    const imageDataToSend = capturedImageData;
    
    closeCamera();
    
    uploadArea.style.display = 'none';
    previewContainer.style.display = 'none';
    loadingContainer.style.display = 'block';
    resultContainer.style.display = 'none';
    
    try {
        const response = await fetch('/api/predict-camera', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ image: imageDataToSend })
        });
        
        const data = await response.json();
        loadingContainer.style.display = 'none';
        
        if (data.success) {
            displayResult(data);
        } else {
            alert('ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            resetUpload();
        }
        
    } catch (error) {
        console.error('ì¹´ë©”ë¼ ë¶„ì„ ì˜¤ë¥˜:', error);
        loadingContainer.style.display = 'none';
        alert('ì„œë²„ ì—°ê²° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        resetUpload();
    }
}
</script>
{% endblock %}
